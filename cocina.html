<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pantalla de Cocina y Caja</title>
    <link rel="stylesheet" href="stylecocina.css">
</head>
<body>

    <header class="kitchen-header">
        <h1>üë®‚Äçüç≥ CAJA Y COCINA</h1>
        <div class="header-controls">
            <button class="btn-corte" onclick="abrirCorteCaja()">üí∞ CORTE DE CAJA</button>
            <div id="clock">00:00:00</div>
        </div>
    </header>

    <div class="orders-container" id="ordersContainer">
        <div class="empty-message">Esperando nuevos pedidos...</div>
    </div>

    <div id="modalPago" class="modal-overlay">
        <div class="modal-box">
            <h2 class="modal-title">Cobrar Pedido</h2>
            <div class="pay-info">Total a Pagar: <span id="lblTotalPagar">$0.00</span></div>
            
            <input type="number" id="inpPagoCliente" class="input-money" placeholder="Ingresa monto recibido" min="0">
            
            <div class="change-display">Cambio: <span id="lblCambio">$0.00</span></div>
            
            <button class="btn-confirm" id="btnFinalizarPago" onclick="finalizarPago()">üí∏ PAGAR Y CERRAR PEDIDO</button>
            <button class="btn-cancel" onclick="cerrarModal('modalPago')">CANCELAR</button>
        </div>
    </div>

    <div id="modalCorte" class="modal-overlay">
        <div class="modal-box" style="width: 500px;">
            <h2 class="modal-title">Corte de Caja</h2>
            
            <div class="sales-table-container">
                <table class="sales-table">
                    <thead>
                        <tr>
                            <th>Hora</th>
                            <th>Pedido</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="tablaVentasBody">
                        </tbody>
                </table>
            </div>

            <div class="total-sales">Ventas Totales: <span id="lblTotalCorte">$0.00</span></div>
            
            <button class="btn-confirm" onclick="cerrarModal('modalCorte')">CERRAR</button>
            <button class="btn-cancel" onclick="limpiarCaja()" style="background:#444; font-size:0.8rem;">üóëÔ∏è BORRAR HISTORIAL (NUEVO D√çA)</button>
        </div>
    </div>

    <script>
        // --- VARIABLES GLOBALES ---
        let pedidoActualIndex = -1; // Para saber qu√© pedido estamos cobrando
        let totalActual = 0;

        // --- RELOJ ---
        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString();
        }, 1000);

        // --- CARGA INICIAL ---
        renderizarPedidos();

        // --- LISTENER DE CAMBIOS (Sincronizaci√≥n con men√∫) ---
        window.addEventListener('storage', (e) => {
            if (e.key === 'pedidosCocina') {
                renderizarPedidos();
            }
        });

        // --- FUNCI√ìN RENDERIZAR PEDIDOS ---
        function renderizarPedidos() {
            const container = document.getElementById('ordersContainer');
            const pedidos = JSON.parse(localStorage.getItem('pedidosCocina')) || [];

            if (pedidos.length === 0) {
                container.innerHTML = '<div class="empty-message">No hay pedidos pendientes üò¥</div>';
                return;
            }

            container.innerHTML = '';

            pedidos.forEach((pedido, index) => {
                const card = document.createElement('div');
                card.className = 'order-card';
                
                let itemsHtml = '';
                pedido.items.forEach(item => {
                    itemsHtml += `<li class="order-item">1x ${item.name} ($${item.price})</li>`;
                });

                // Calculamos el total por seguridad (o usamos el que viene guardado)
                const total = pedido.total || 0;

                card.innerHTML = `
                    <div class="order-header">
                        <span class="order-id">#${String(pedido.id).slice(-4)}</span>
                        <span class="order-time">${pedido.hora}</span>
                    </div>
                    <ul class="order-list">
                        ${itemsHtml}
                    </ul>
                    <div style="text-align:center; padding:10px; font-weight:bold; color:#008000; font-size:1.2rem;">
                        TOTAL: $${total}.00
                    </div>
                    <button class="btn-pay-card" onclick="abrirModalPago(${index}, ${total})">üí∞ COBRAR PEDIDO</button>
                `;
                container.appendChild(card);
            });
        }

        // --- L√ìGICA DE COBRO ---
        function abrirModalPago(index, total) {
            pedidoActualIndex = index;
            totalActual = total;

            document.getElementById('lblTotalPagar').innerText = `$${total}.00`;
            document.getElementById('inpPagoCliente').value = '';
            document.getElementById('lblCambio').innerText = '$0.00';
            document.getElementById('modalPago').style.display = 'flex';
            
            // Enfocar el input
            document.getElementById('inpPagoCliente').focus();
        }

        // Detectar entrada de dinero para calcular cambio
        document.getElementById('inpPagoCliente').addEventListener('input', function() {
            const pago = parseFloat(this.value);
            const cambio = pago - totalActual;
            const btn = document.getElementById('btnFinalizarPago');
            const lblCambio = document.getElementById('lblCambio');

            if (!isNaN(pago)) {
                lblCambio.innerText = `$${cambio.toFixed(2)}`;
                if (cambio >= 0) {
                    lblCambio.style.color = "#008000"; // Verde si alcanza
                    btn.disabled = false;
                    btn.style.opacity = "1";
                    btn.style.cursor = "pointer";
                } else {
                    lblCambio.style.color = "#d32f2f"; // Rojo si falta
                    btn.disabled = true;
                    btn.style.opacity = "0.5";
                    btn.style.cursor = "not-allowed";
                }
            } else {
                lblCambio.innerText = "$0.00";
            }
        });

        function finalizarPago() {
            const pagoInput = document.getElementById('inpPagoCliente').value;
            if(!pagoInput || parseFloat(pagoInput) < totalActual) {
                alert("El monto ingresado es insuficiente.");
                return;
            }

            // 1. Obtener pedidos pendientes
            let pedidos = JSON.parse(localStorage.getItem('pedidosCocina')) || [];
            
            // 2. Obtener el pedido actual
            const pedidoPagado = pedidos[pedidoActualIndex];

            // 3. Guardar en HISTORIAL DE VENTAS (Corte de Caja)
            let ventas = JSON.parse(localStorage.getItem('ventasDia')) || [];
            ventas.push(pedidoPagado);
            localStorage.setItem('ventasDia', JSON.stringify(ventas));

            // 4. Eliminar de pendientes
            pedidos.splice(pedidoActualIndex, 1);
            localStorage.setItem('pedidosCocina', JSON.stringify(pedidos));

            // 5. Refrescar interfaz y cerrar
            renderizarPedidos();
            cerrarModal('modalPago');
        }

        // --- L√ìGICA DE CORTE DE CAJA ---
        function abrirCorteCaja() {
            const ventas = JSON.parse(localStorage.getItem('ventasDia')) || [];
            const tbody = document.getElementById('tablaVentasBody');
            const lblTotal = document.getElementById('lblTotalCorte');
            
            tbody.innerHTML = '';
            let sumaTotal = 0;

            if(ventas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">No hay ventas registradas hoy.</td></tr>';
            } else {
                ventas.forEach(venta => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${venta.hora}</td>
                        <td>#${String(venta.id).slice(-4)}</td>
                        <td>$${venta.total}</td>
                    `;
                    tbody.appendChild(tr);
                    sumaTotal += venta.total;
                });
            }

            lblTotal.innerText = `$${sumaTotal}.00`;
            document.getElementById('modalCorte').style.display = 'flex';
        }

        function limpiarCaja() {
            if(confirm("‚ö†Ô∏è ¬øEst√°s seguro de borrar el historial de ventas? Haz esto solo al inicio de un nuevo d√≠a.")) {
                localStorage.removeItem('ventasDia');
                abrirCorteCaja(); // Refrescar modal vac√≠o
            }
        }

        // --- UTILIDADES ---
        function cerrarModal(id) {
            document.getElementById(id).style.display = 'none';
        }
    </script>
</body>
</html>